name: Build and Release Fluent Bit

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Fluent Bit version to build (e.g., 4.2.0, leave empty for latest)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (build only, no release)'
        required: false
        type: boolean
        default: false
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 00:00 UTC to check for new releases
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      latest_version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_release.outputs.should_build }}
      is_dry_run: ${{ steps.set_dry_run.outputs.is_dry_run }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine dry run mode
        id: set_dry_run
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]] || [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "is_dry_run=true" >> $GITHUB_OUTPUT
            echo "Running in DRY RUN mode - will build but not create release"
          else
            echo "is_dry_run=false" >> $GITHUB_OUTPUT
            echo "Running in NORMAL mode - will build and create release"
          fi

      - name: Get Fluent Bit version
        id: get_version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
            echo "Using specified version: $VERSION"
          else
            VERSION=$(curl -s https://api.github.com/repos/fluent/fluent-bit/releases/latest | jq -r '.tag_name' | sed 's/^v//')
            echo "Using latest version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Fluent Bit version: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          IS_DRY_RUN="${{ steps.set_dry_run.outputs.is_dry_run }}"
          MANUAL_VERSION="${{ inputs.version }}"

          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "Dry run mode: will build regardless of existing release"
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [[ -n "$MANUAL_VERSION" ]]; then
            echo "Manual version specified: will build regardless of existing release"
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif gh release view "v$VERSION" > /dev/null 2>&1; then
            echo "::warning::Release v$VERSION already exists, skipping build"
            echo "Release v$VERSION already exists"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Release v$VERSION does not exist, will build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  skip-notification:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Notify skip
        run: |
          echo "::notice::Skipping build - Fluent Bit v${{ needs.check-version.outputs.latest_version }} already released"
          echo "No new version to build. Current latest: v${{ needs.check-version.outputs.latest_version }}"

  build-deps:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            flex \
            bison \
            wget \
            git

      - name: Build zlib statically
        run: |
          cd /tmp
          wget https://zlib.net/zlib-1.3.1.tar.gz
          tar -xzf zlib-1.3.1.tar.gz
          cd zlib-1.3.1
          ./configure --prefix=/usr/local/zlib --static
          make -j$(nproc)
          sudo make install
          cd /
          rm -rf /tmp/zlib-1.3.1*

      - name: Build zstd statically
        run: |
          cd /tmp
          wget https://github.com/facebook/zstd/releases/download/v1.5.6/zstd-1.5.6.tar.gz
          tar -xzf zstd-1.5.6.tar.gz
          cd zstd-1.5.6/build/cmake
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_SHARED_LIBS=OFF \
                -DZSTD_BUILD_SHARED=OFF \
                -DZSTD_BUILD_STATIC=ON \
                -DZSTD_BUILD_PROGRAMS=OFF \
                -DZSTD_BUILD_CONTRIB=OFF \
                -DZSTD_BUILD_TESTS=OFF \
                -DCMAKE_INSTALL_PREFIX=/usr/local/zstd \
                .
          make -j$(nproc)
          sudo make install
          cd /
          rm -rf /tmp/zstd-1.5.6*

      - name: Build OpenSSL statically
        run: |
          cd /tmp
          wget https://www.openssl.org/source/openssl-3.0.15.tar.gz
          tar -xzf openssl-3.0.15.tar.gz
          cd openssl-3.0.15
          ./config no-shared --prefix=/usr/local/ssl
          make -j$(nproc)
          sudo make install
          cd /
          rm -rf /tmp/openssl-3.0.15*

      - name: Cache dependencies
        run: |
          mkdir -p deps-cache
          sudo tar -czf deps-cache/static-libs.tar.gz \
            /usr/local/zlib \
            /usr/local/zstd \
            /usr/local/ssl

      - name: Upload dependencies
        uses: actions/upload-artifact@v4
        with:
          name: static-dependencies
          path: deps-cache/static-libs.tar.gz
          retention-days: 1

  build:
    needs: [check-version, build-deps]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - name: "no-lua"
            suffix: "static"
            luajit: "No"
            description: "Static build without Lua support"
          - name: "luajit"
            suffix: "static-luajit"
            luajit: "Yes"
            description: "Static build with LuaJIT support"
    steps:
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            flex \
            bison \
            wget \
            git

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: static-dependencies
          path: deps-cache

      - name: Extract dependencies
        run: |
          sudo tar -xzf deps-cache/static-libs.tar.gz -C /

      - name: Download Fluent Bit source
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"
          wget "https://github.com/fluent/fluent-bit/archive/refs/tags/v${VERSION}.tar.gz"
          tar -xzf "v${VERSION}.tar.gz"
          cd "fluent-bit-${VERSION}"

      - name: Build Fluent Bit statically (${{ matrix.variant.description }})
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"
          cd "fluent-bit-${VERSION}"

          # Remove build directory if it exists and create fresh one
          rm -rf build
          mkdir build
          cd build

          # Configure with static linking
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DFLB_RELEASE=On \
                -DFLB_DEBUG=No \
                -DFLB_STATIC_LIBS=On \
                -DFLB_SHARED_LIB=Off \
                -DFLB_TRACE=On \
                -DFLB_IN_SYSTEMD=Off \
                -DFLB_CONFIG_YAML=Off \
                -DFLB_WASM=No \
                -DFLB_LUAJIT=${{ matrix.variant.luajit }} \
                -DOPENSSL_ROOT_DIR=/usr/local/ssl \
                -DOPENSSL_USE_STATIC_LIBS=ON \
                -DZLIB_ROOT=/usr/local/zlib \
                -DZLIB_USE_STATIC_LIBS=ON \
                -DCMAKE_PREFIX_PATH="/usr/local/zstd" \
                -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
                -DBUILD_SHARED_LIBS=OFF \
                -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc" \
                -DCMAKE_C_FLAGS="-fcommon" \
                ..

          # Build
          make -j$(nproc)

          # Verify the binary is statically linked
          file bin/fluent-bit
          ldd bin/fluent-bit || echo "Binary is statically linked (expected)"

      - name: Package artifacts (${{ matrix.variant.name }})
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"
          VARIANT="${{ matrix.variant.name }}"
          SUFFIX="${{ matrix.variant.suffix }}"
          cd "fluent-bit-${VERSION}/build"

          # Create package directory
          mkdir -p fluent-bit-linux-x86_64
          cp bin/fluent-bit fluent-bit-linux-x86_64/

          # Create tarball with variant suffix
          tar -czf "fluent-bit-${VERSION}-linux-x86_64-${SUFFIX}.tar.gz" fluent-bit-linux-x86_64

          # Generate checksums
          sha256sum "fluent-bit-${VERSION}-linux-x86_64-${SUFFIX}.tar.gz" > "fluent-bit-${VERSION}-linux-x86_64-${SUFFIX}.tar.gz.sha256"
          sha512sum "fluent-bit-${VERSION}-linux-x86_64-${SUFFIX}.tar.gz" > "fluent-bit-${VERSION}-linux-x86_64-${SUFFIX}.tar.gz.sha512"

          # Move to workspace root
          mv "fluent-bit-${VERSION}-linux-x86_64-${SUFFIX}.tar.gz"* "$GITHUB_WORKSPACE/"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fluent-bit-linux-x86_64-${{ matrix.variant.name }}
          path: |
            fluent-bit-*.tar.gz
            fluent-bit-*.tar.gz.sha256
            fluent-bit-*.tar.gz.sha512

  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.is_dry_run == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: fluent-bit-linux-x86_64-*
          merge-multiple: true

      - name: Create Release
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"

          cat > release_notes.md << 'EOF'
          Statically compiled Fluent Bit v$VERSION for Linux x86_64

          This release contains statically linked binaries of Fluent Bit built from the official source at https://github.com/fluent/fluent-bit/releases/tag/v$VERSION

          ## Build Variants

          ### Standard Build (Recommended for most users)
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/fluent-bit-$VERSION-linux-x86_64-static.tar.gz
          tar -xzf fluent-bit-$VERSION-linux-x86_64-static.tar.gz
          cd fluent-bit-linux-x86_64
          ./fluent-bit --version
          ```
          - **Features**: Fully static, zero dependencies, maximum portability
          - **Limitations**: No Lua filter support
          - **Use case**: Production deployments where Lua filters are not needed

          ### LuaJIT Build (For Lua filter support)
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz
          tar -xzf fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz
          cd fluent-bit-linux-x86_64
          ./fluent-bit --version
          ```
          - **Features**: Fully static with embedded LuaJIT, supports Lua filters
          - **Limitations**: Slightly larger binary size
          - **Use case**: When you need Lua filter plugin functionality

          ## Verification

          Each variant includes SHA256 and SHA512 checksums:

          ```bash
          # For standard build
          wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/fluent-bit-$VERSION-linux-x86_64-static.tar.gz.sha256
          sha256sum -c fluent-bit-$VERSION-linux-x86_64-static.tar.gz.sha256

          # For LuaJIT build
          wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz.sha256
          sha256sum -c fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz.sha256
          ```

          ## Included Artifacts

          **Standard Build:**
          - `fluent-bit-$VERSION-linux-x86_64-static.tar.gz`: Binary without Lua support
          - `fluent-bit-$VERSION-linux-x86_64-static.tar.gz.sha256`: SHA256 checksum
          - `fluent-bit-$VERSION-linux-x86_64-static.tar.gz.sha512`: SHA512 checksum

          **LuaJIT Build:**
          - `fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz`: Binary with LuaJIT support
          - `fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz.sha256`: SHA256 checksum
          - `fluent-bit-$VERSION-linux-x86_64-static-luajit.tar.gz.sha512`: SHA512 checksum
          EOF

          sed -i "s/\$VERSION/${VERSION}/g" release_notes.md

          gh release create "v${VERSION}" \
            --title "Fluent Bit v${VERSION}" \
            --notes-file release_notes.md \
            fluent-bit-*.tar.gz \
            fluent-bit-*.tar.gz.sha256 \
            fluent-bit-*.tar.gz.sha512
        env:
          GH_TOKEN: ${{ github.token }}

  dry-run-summary:
    needs: [check-version, build]
    if: needs.check-version.outputs.is_dry_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: fluent-bit-linux-x86_64-*
          merge-multiple: true

      - name: Dry run summary
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"
          echo "::notice::DRY RUN COMPLETED SUCCESSFULLY"
          echo "::notice::Fluent Bit v${VERSION} was built and packaged (multiple variants)"
          echo "::notice::In production mode, this would create a release"
          echo ""
          echo "Build artifacts:"
          ls -lh fluent-bit-*.tar.gz
          echo ""
          echo "Artifact sizes:"
          du -h fluent-bit-*.tar.gz
          echo ""
          echo "Variants built:"
          echo "  - Standard (no Lua): fluent-bit-${VERSION}-linux-x86_64-static.tar.gz"
          echo "  - LuaJIT enabled: fluent-bit-${VERSION}-linux-x86_64-static-luajit.tar.gz"
